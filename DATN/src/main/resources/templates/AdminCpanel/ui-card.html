<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Furniture E-Commerce</title>
  <link rel="shortcut icon" type="image/png" href="../assets/images/logos/Logo1.png" />
  <link rel="stylesheet" href="../assets/css/styles.min.css" />
</head>

<body>
  <!--  Body Wrapper -->
  <body>
    <!--  Body Wrapper -->
    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
      data-sidebar-position="fixed" data-header-position="fixed">
      <!-- Sidebar Start -->
      <aside class="left-sidebar">
        <!-- Sidebar scroll-->
        <div>
         
          <!-- Sidebar navigation-->
          <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
            <ul id="sidebarnav">
              <li class="nav-small-cap"><i class="ti ti-dots nav-small-cap-icon fs-4"></i> <span
                  class="hide-menu">Home</span></li>
              <li class="sidebar-item"><a class="sidebar-link" th:href="@{/}" aria-expanded="false"> <span> <i
                      class="ti ti-layout-dashboard"></i>
                  </span> <span class="hide-menu">Trang chủ</span>
                </a></li>
              <li class="nav-small-cap"><i class="ti ti-dots nav-small-cap-icon fs-4"></i> <span
                  class="hide-menu">Quản Lí </span></li>
              <li class="sidebar-item"><a class="sidebar-link" th:href="@{/admin/products}"
                  aria-expanded="false"> <span>
                    <i class="ti ti-article"></i>
                  </span> <span class="hide-menu">Sản Phẩm</span>
                </a></li>
              <li class="sidebar-item"><a class="sidebar-link" th:href="@{/admin/accounts}"
                  aria-expanded="false"> <span>
                    <i class="ti ti-user"></i>
                  </span> <span class="hide-menu">Tài Khoản</span>
                </a></li>
              <li class="sidebar-item"><a class="sidebar-link" th:href="@{/admin/revenue-chart}"
                  aria-expanded="false"> <span>
                    <i class="ti ti-cards"></i>
                  </span> <span class="hide-menu">Doanh Thu</span>
                </a></li>
              <li class="sidebar-item"><a class="sidebar-link" th:href="@{/admin/feedback}"
                  aria-expanded="false"> <span>
                    <i class="ti ti-file-description"></i>
                  </span> <span class="hide-menu">Feedback</span>
                </a></li>
              <li class="sidebar-item"><a class="sidebar-link" th:href="@{/admin/orders}"
                  aria-expanded="false"> <span>
                    <i class="ti ti-shopping-cart"></i>
                  </span> <span class="hide-menu">Đơn Hàng</span>
                </a></li>
  
  
              <li class="sidebar-item"><a class="sidebar-link" th:href="@{/admin/vouchers}"
                  aria-expanded="false"> <span>
                    <i class="ti ti-ticket"></i>
                  </span> <span class="hide-menu">Mã giảm giá</span>
                </a></li>
              <li class="sidebar-item">
                <a class="sidebar-link" th:href="@{/admin/history}" aria-expanded="false">
                  <span>
                    <i class="ti ti-typography"></i>
                  </span>
                  <span class="hide-menu">Lịch sử nhập hàng</span>
                </a>
              </li>
            </ul>
  
          </nav>
          <!-- End Sidebar navigation -->
        </div>
      <!-- End Sidebar scroll-->
    </aside>
    <!--  Sidebar End -->
    <!--  Main wrapper -->
    <div class="body-wrapper">
      <!--  Header Start -->
     
      
      <div class="filter-by-year">
        <select id="yearDropdown" onchange="filterByYear()">
          <!-- Option elements will be added dynamically using JavaScript -->
          
        </select>
      </div>
      
    
    
      
       <div class="container-fluid">
    <div class="container-fluid">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-12">
              <h5 class="card-title fw-semibold mb-4">Quản Lí Doanh Thu</h5>
                <h5>Tổng tiền bán ra: <span th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span></h5>
                <h5>Tổng tiền nhập hàng: <span th:text="${#numbers.formatDecimal(totalPurchaseCost, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span></h5>
                <h5>Tổng Doanh thu: <span th:text="${#numbers.formatDecimal(NetRevenues, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span></h5>
               
             <canvas id="myChart"></canvas>

    <!-- Hiển thị bảng thống kê theo tháng -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Tháng</th>
                <th>Tiền bán ra</th>
                <th>Tiền nhập hàng</th>
                <th>Doanh Thu</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- <tr th:each="entry : ${monthlyRevenues}"> -->
                <!-- <td th:text="${entry.key}"></td> Tháng -->
                <!-- <td th:text="${#numbers.formatDecimal(entry.value, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td> Doanh thu -->
                <!-- <td th:text="${#numbers.formatDecimal(totalPurchasePrices[entry.key], 0, 'COMMA', 0, 'POINT')} + ' VND'"></td> Tiền mua vào -->
                <!-- <td th:text="${#numbers.formatDecimal(monthlyNetRevenues[entry.key], 0, 'COMMA', 0, 'POINT')} + ' VND'"></td> Net Revenue -->
            <!-- </tr> -->
        </tbody>
    </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  </div>
   <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
   <script th:inline="javascript">

var monthlyRevenues = /*[[${monthlyRevenues}]]*/ {};
    var totalRevenue = /*[[${totalRevenue}]]*/ 0;
    var totalPurchasePrices = /*[[${totalPurchasePrices}]]*/ {};
    var monthlyNetRevenues = /*[[${monthlyNetRevenues}]]*/ {};
    var NetRevenues = /*[[${NetRevenues}]]*/ 0;
    var totalPurchaseCost = /*[[${totalPurchaseCost}]]*/ 0;

    const yearDropdown = document.getElementById('yearDropdown');
  
    // Gọi API để lấy danh sách các năm khi trang được tải
    fetch('/api/revenue/getAllYears')
      .then(response => response.json())
      .then(data => {
        // Xóa tất cả các option cũ trong dropdown nếu có
        yearDropdown.innerHTML = '';
  
        // Tạo các option mới cho dropdown từ dữ liệu nhận được từ API
        data.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearDropdown.appendChild(option);
        });
      })
      .catch(error => console.error('Error fetching years:', error));
  
    // Hàm xử lý khi người dùng chọn năm
    function filterByYear() {
      const selectedYear = yearDropdown.value;
  
      // Gọi API để lấy dữ liệu dựa trên năm đã chọn
      fetch(`/api/revenues?year=${selectedYear}`)
        .then(response => response.json())
        .then(data => {
          // Xóa dữ liệu cũ trong bảng
          const tableBody = document.getElementById('tableBody');
          tableBody.innerHTML = '';
  
          // Thêm dữ liệu mới vào bảng
          data.monthlyRevenues.forEach((value, key) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${key}</td>
              <td>${formatCurrency(value)}</td>
              <td>${formatCurrency(data.totalPurchasePrices[key])}</td>
              <td>${formatCurrency(data.monthlyNetRevenues[key])}</td>
            `;
            tableBody.appendChild(row);
          });
  
          // Cập nhật dữ liệu cho biểu đồ
          updateChartData(data);
        })
        .catch(error => console.error('Error fetching data:', error));
    }
  
    // Hàm cập nhật dữ liệu cho biểu đồ
    function updateChartData(data) {
      const months = Object.keys(data.monthlyRevenues);
      const revenueValues = Object.values(data.monthlyRevenues);
      const purchaseValues = Object.values(data.totalPurchasePrices);
      const netRevenueValues = Object.values(data.monthlyNetRevenues);
  
      const ctx = document.getElementById('myChart').getContext('2d');
      const myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Tiền bán ra',
              data: revenueValues,
              fill: false,
              borderColor: '#000000',
              pointBorderColor: '#000000',
              pointRadius: 5,
            },
            {
              label: 'Tiền nhập hàng',
              data: purchaseValues,
              fill: false,
              borderColor: '#ff0000',
              pointBorderColor: '#ff0000',
              pointRadius: 5,
            },
            {
              label: 'Doanh thu',
              data: netRevenueValues,
              fill: false,
              borderColor: '#00ff00',
              pointBorderColor: '#00ff00',
              pointRadius: 5,
            },
          ],
        },
        options: {
          title: {
            text: 'Biểu đồ doanh thu',
            fontSize: 20,
          },
          yAxis: {
            title: {
              text: 'Doanh thu (VND)',
            },
          },
        },
      });
    }
  
    // Hàm định dạng số tiền thành chuỗi có dấu phân cách
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }
  </script>

  <script src="../assets/libs/jquery/dist/jquery.min.js"></script>
  <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/sidebarmenu.js"></script>
  <script src="../assets/js/app.min.js"></script>
  <script src="../assets/libs/simplebar/dist/simplebar.js"></script>
</body>
</html>